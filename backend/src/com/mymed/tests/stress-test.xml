<?xml version="1.0" encoding="UTF-8"?>
<!--
Ant build file to run the stress test for mymed.
It depends on the build.xml files, since it needs also some JARs that are created there.

Milo Casagrande <milo.casagrande@inria.fr>, 2011
-->
<project name="mymed-stress-test" default="compile" basedir=".">
	<property name="build.dir"           location="build"/>
	<property name="conf.dir"            location="../../../../conf"/>
  <property name="tests.dir"           location="stress"/>
	<property name="lib.dir"             location="lib" />
  <property name="controller.dir"      location="../controller"/>
  <property name="model.dir"           location="../model"/>
  <property name="utils.dir"           location="../utils"/>
  <property name="java.dir"            location="/usr/share/java"/>
  <property name="findbugs.dir"        location="/usr/share/findbugs"/>
	<property name="libs.dir"            location="../../../../lib"/>
  <property name="cassandra.dir"       location="../../../../protocols/cassandra/cassandra"/>
  <property name="src.dir"             location="${controller.dir}:${model.dir}:${utils.dir}"/>
	<property name="test.jar"            value="stresstest.jar" />

  <!-- Fix the classpath to add the necessary resources -->
	<path id="mymed.classpath" description="Classpath to be used for running the tests">
	  <pathelement path="${java.class.path}"/>
	  <pathelement location="."/>
		<pathelement location="${conf.dir}"/>
    <pathelement location="${lib.dir}/mymed.jar"/>
    <pathelement location="${lib.dir}/jSynapse.jar"/>
    <pathelement location="${lib.dir}/mymedtest.jar"/>
    <pathelement location="${lib.dir}/stresstest.jar"/>
	  <fileset dir="${libs.dir}">
	    <include name="*.jar"/>
	    <include name="**/*.jar"/>
	  </fileset>
    <fileset dir="${cassandra.dir}/lib">
      <include name="*.jar"/>
      <include name="**/*.jar"/>
      <!-- We exclude this JAR here otherwise SLF4J will throw a warning, nothing blocking, but
      not good to see. For more info see: http://www.slf4j.org/codes.html#multiple_bindings
      Cassandra has sl4j binding in its classpath, that's why it complains -->
      <exclude name="slf4j-log4j12-1.6.1.jar"/>
    </fileset>
	</path>

  <!-- Used if we want to pretty print the classpath in case we need to debug -->
  <pathconvert description="Pretty print the classpath" property="echo.path.compile" refid="mymed.classpath" pathsep="${line.separator}|  |--" />

  <!-- Create the directories structure -->
  <target name="init" description="Initialize the necessary directories">
    <mkdir dir="${build.dir}"/>
  	<mkdir dir="${lib.dir}"/>
  </target>

	<!-- Compile the stress tests -->
	<target name="compile" depends="init,clean" description="Compile the stress tests">
		<javac srcdir="${tests.dir}" destdir="${build.dir}" debug="on" fork="true">
			<classpath refid="mymed.classpath"/>
		  <include name="**/*.java"/>
		</javac>
		<jar destfile="${lib.dir}/${test.jar}" basedir="${build.dir}" duplicate="preserve" index="true"/>
	</target>

	<!-- Run the tests on the User column family -->
	<target name="user" depends="compile" description="Run the stress test on the User column family" >
		<java fork="true" classname="com.mymed.tests.stress.UserStressTest">
		  <classpath refid="mymed.classpath"/>
		</java>
	</target>

	<!-- Run the tests on the Session column family -->
	<target name="session" depends="compile" description="Run the stress test on the Session column family" >
		<java fork="true" classname="com.mymed.tests.stress.SessionStressTest">
		  <classpath refid="mymed.classpath"/>
		</java>
	</target>

	<!-- Run the tests on the User and Session column family -->
	<target name="usersession" depends="compile" description="Run the stress test on the User and Session column family" >
		<java fork="true" classname="com.mymed.tests.stress.UserSessionStressTest">
		  <classpath refid="mymed.classpath"/>
		</java>
	</target>

	<!-- Run the tests on the Authentication column family -->
	<target name="auth" depends="compile" description="Run the stress test on the Authentication column family" >
		<java fork="true" classname="com.mymed.tests.stress.AuthenticationStressTest">
		  <classpath refid="mymed.classpath"/>
		</java>
	</target>

	<!-- Run the tests on the Authentication, User and Session column family -->
	<target name="alltest" depends="compile" description="Run the stress test on the Authentication, User and Session column family" >
		<java fork="true" classname="com.mymed.tests.stress.AuthUserSessionStressTest">
		  <classpath refid="mymed.classpath"/>
		</java>
	</target>

  <!-- Clean up everything -->
  <target name="clean" description="Clean the directories used for the build">
  	<delete includeemptydirs="true" failonerror="false">
  	  <fileset dir="${build.dir}" includes="**/*"/>
  	</delete>
  </target>
</project>
