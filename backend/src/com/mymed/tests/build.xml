<?xml version="1.0" encoding="UTF-8"?>
<!--
Ant build file to run JUnit tests for mymed

Milo Casagrande <milo.casagrande@inria.fr>, 2011
-->
<project name="mymed" default="test" basedir=".">
	<property name="build.dir"           location="build"/>
	<property name="lib.dir"             location="lib" />
	<property name="results.dir"         location="results"/>
	<property name="tests.dir"           location="unit"/>
	<property name="controller.dir"      location="../controller"/>
	<property name="model.dir"           location="../model"/>
	<property name="utils.dir"           location="../utils"/>
	<property name="libs.dir"            location="../../../../lib"/>
	<property name="java.dir"            location="/usr/share/java"/>
	<property name="cassandra.dir"       location="../../../../protocols/cassandra/cassandra"/>
	<property name="synapse.dir"         location="../../../../protocols/synapse/jSynapse/src"/>
	<property name="src.dir"             location="${controller.dir}:${model.dir}:${utils.dir}"/>
	<property name="jsynapse.jar"        value="jSynapse.jar"/>
	<property name="mymed.jar"           value="mymed.jar"/>
	<property name="mymedtest.jar"       value="mymedtest.jar"/>

 <!-- Fix the classpath to add the necessary resources -->
	<path id="mymed.classpath" description="Classpath to be used for running the tests">
		<pathelement path="${java.class.path}"/>
	  <pathelement location="${lib.dir}/mymed.jar"/>
	  <pathelement location="${lib.dir}/jSynapse.jar"/>
	  <pathelement location="${lib.dir}/mymedtest.jar"/>
	  <pathelement location="."/>
		<fileset dir="${libs.dir}" includes="*.jar" />
		<fileset dir="${cassandra.dir}/lib" includes="*.jar"/>
		<!-- This is necessary for JUnit to work under Jenkins -->
		<!-- Looks like it is necessary to specify the path to the needed JARs -->
		<fileset dir="${java.dir}">
			<include name="**/junit.jar"/>
			<include name="*.jar"/>
			<include name="**/*.jar"/>
		</fileset>
	</path>

	<!-- Used if we want to pretty print the classpath in case we need to debug -->
	<pathconvert description="Pretty print the classpath" property="echo.path.compile" refid="mymed.classpath" pathsep="${line.separator}|  |--" />

	<!-- Create the directories structure -->
	<target name="init" depends="clean" description="Initialize the necessary directories">
		<mkdir dir="${build.dir}" />
		<mkdir dir="${lib.dir}" />
	</target>

	<!-- Build synapse -->
	<target name="synapse" depends="init" description="Compile and create the Synapse JAR">
		<javac srcdir="${synapse.dir}" destdir="${build.dir}" debug="on">
			<classpath refid="mymed.classpath"/>
		</javac>
		<jar destfile="${lib.dir}/${jsynapse.jar}" basedir="${build.dir}" duplicate="preserve" index="true" />
	</target>

	<!-- Compile mymed -->
	<target name="compile" depends="synapse,cleanbuild" description="Compile the necessary files">
		<javac srcdir="${src.dir}" destdir="${build.dir}" debug="on">
			<classpath refid="mymed.classpath"/>
		</javac>
		<jar destfile="${lib.dir}/${mymed.jar}" basedir="${build.dir}" duplicate="preserve" index="true"/>
	</target>

	<!-- Compile the tests -->
	<target name="compiletest" depends="compile,cleanbuild" description="Compile the test classes">
		<javac srcdir="${tests.dir}" destdir="${build.dir}" debug="on">
			<classpath refid="mymed.classpath"/>
			<include name="**/*.java"/>
		</javac>
		<jar destfile="${lib.dir}/${mymedtest.jar}" basedir="${build.dir}" duplicate="preserve" index="true"/>
	</target>

	<!-- Run the tests -->
	<target name="test" depends="compiletest" description="Run all the JUnit tests">
		<junit printsummary="yes" haltonfailure="no" showoutput="yes">
			<classpath refid="mymed.classpath"/>
			<test name="com.mymed.tests.unit.MyMedTestSuite" todir="${results}"/>
			<formatter type="xml"/>
			<batchtest fork="true"/>
		</junit>
	</target>

	<!-- Clean the build dir so that we have small new JARs -->
	<target name="cleanbuild" description="Clean the build directory from other directories">
		<delete includeemptydirs="true" failonerror="false">
		  <fileset dir="${build.dir}" includes="**/*"/>
		</delete>
	</target>

	<!-- Clean up everything -->
	<target name="clean" description="Remove the directories used for the build">
	  <delete dir="${build.dir}" />
		<delete dir="${lib.dir}" />
	</target>
</project>