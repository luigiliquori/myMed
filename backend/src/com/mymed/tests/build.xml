<?xml version="1.0" encoding="UTF-8"?>
<!--
Ant build file to run JUnit tests for mymed class

Milo Casagrande <milo.casagrande@inria.fr>, 2011
-->
<project name="mymed" default="test" basedir=".">
	<property name="build.dir"           location="build" />
	<property name="lib.dir"             location="lib" />
	<property name="tests.dir"           location="." />
	<property name="controller.dir"      location="../controller" />
	<property name="model.dir"           location="../model" />
	<property name="utils.dir"           location="../utils" />
	<property name="libs.dir"            location="../../../../lib" />
	<property name="junit.dir"           location="/usr/share/junit" />
	<property name="cassandra.dir"       location="../../../../protocols/cassandra/cassandra" />
	<property name="synapse.dir"         location="../../../../protocols/synapse/jSynapse/src" />
	<property name="src.dir"             location="${controller.dir}:${model.dir}:${utils.dir}" />

 <!-- Fix the classpath to add the necessary resources -->
	<path id="mymed.classpath">
		<pathelement path="${java.class.path}"/>
	  <pathelement location="${lib.dir}/mymed.jar"/>
	  <pathelement location="${lib.dir}/jSynapse.jar"/>
	  <pathelement location="${lib.dir}/mymedtest.jar"/>
	  <pathelement location="."/>
		<fileset dir="${libs.dir}" includes="*.jar" />
		<fileset dir="${cassandra.dir}/lib" includes="*.jar"/>
		<fileset dir="${junit.dir}">
			<include name="**/junit.jar"/>
		</fileset>
	</path>

	<!-- Used if we want to print the classpath in case we need to debug -->
	<pathconvert property="echo.path.compile" refid="mymed.classpath" pathsep="${line.separator}|  |--" />

	<!-- Create the directories structure -->
	<target name="init" depends="clean" description="Initialize the necessary directories">
		<mkdir dir="${build.dir}" />
		<mkdir dir="${lib.dir}" />
	</target>

	<!-- Build synapse -->
	<target name="synapse" depends="init" description="Compile and create the Synapse JAR">
		<javac srcdir="${synapse.dir}" destdir="${build.dir}" debug="on">
			<classpath refid="mymed.classpath"/>
		</javac>
		<jar destfile="${lib.dir}/jSynapse.jar" basedir="${build.dir}" duplicate="preserve" index="true" />
	</target>

	<!-- Compile mymed -->
	<target name="compile" depends="synapse,cleanbuild" description="Compile the necessary files">
		<javac srcdir="${src.dir}" destdir="${build.dir}" debug="on">
			<exclude name="InteractionManagerTest.java"/>
			<classpath refid="mymed.classpath"/>
		</javac>
		<jar destfile="${lib.dir}/mymed.jar" basedir="${build.dir}" duplicate="preserve" index="true"/>
	</target>

	<!-- Compile the tests -->
	<target name="compiletest" depends="compile,cleanbuild" description="Compile the test classes">
		<javac srcdir="${tests.dir}" destdir="${build.dir}" debug="on">
			<classpath refid="mymed.classpath"/>
			<exclude name="InteractionManagerTest*"/>
			<include name="*.java"/>
		</javac>
		<jar destfile="${lib.dir}/mymedtest.jar" basedir="${build.dir}" duplicate="preserve" index="true"/>
	</target>

	<!-- Run the tests -->
	<target name="test" depends="compiletest" description="Run all the JUnit tests">
	  <echo message="|-- mymed classpath"/>
	  <echo message="|  |"/>
	  <echo message="|  |-- ${echo.path.compile}"/>
		<junit printsummary="yes" haltonfailure="no" showoutput="yes">
			<classpath refid="mymed.classpath"/>
			<test name="com.mymed.tests.MyMedTestSuite"/>
			<formatter type="plain"/>
		</junit>
	</target>

	<!-- Clean the JARs so that we have small new JARs for the compile -->
	<target name="cleanbuild" description="Clean the build dir from other directories">
		<delete includeemptydirs="true" failonerror="false">
		  <fileset dir="${build.dir}" includes="**/*"/>
		</delete>
	</target>

	<!-- Clean up everything -->
	<target name="clean" description="Remove the directories used for the build">
	  <delete dir="${build.dir}" />
		<delete dir="${lib.dir}" />
	</target>
</project>