<?php
require_once dirname(__FILE__).'/ConnexionAutoOpenId.class.php';
require_once dirname(__FILE__).'/Auth/OAuth.php';
/**
 * A class to define a Myspace login
 * @author blanchard
 */
class ConnexionMySpace extends ConnexionAutoOpenId
{
	protected $social_network = 'Myspace';
	private	$oAuthConsumer;
	public function __construct()
	{
		if(isset($_REQUEST['connexionProvider'])&&$_REQUEST['connexionProvider']==$this->social_network)
		{
			$this->oAuthConsumer	= new OAuthConsumer('ca09cf41d3c047ecbed4eeac8b6f14c7', 'b9e2b88eb7aa4b878f913db25c1bb3f60bcbf3cdb99c47fb99e5aed9d5919eb5');
			parent::__construct();
		}
	}
	/**
	 * Try to connect on mymed with openid.
	 */
	protected /*void*/ function tryConnect()
	{
		if(isset($_REQUEST['connexion'], $_REQUEST['oidUri'])&&$_REQUEST['connexion']=='openid')
			$this->redirectProvider($_REQUEST['oidUri']);
		elseif(isset($_GET['janrain_nonce']))
		{
			$data	= $this->connect();
			$_SESSION['user'] = new Profile;
			$_SESSION['user']->mymedID			= $this->social_network.self::getField($data, OPENID_KEY_ID);
			$_SESSION['user']->socialNetworkID	= self::getField($data, OPENID_KEY_ID);
			$_SESSION['user']->socialNetworkName= $this->social_network;
			$_SESSION['user']->name				= self::getField($data, OPENID_KEY_FULLNAME);
			$_SESSION['user']->gender			= self::getField($data, OPENID_KEY_GENDER);
			$_SESSION['user']->birthday			= self::getField($data, OPENID_KEY_DATEOFBIRTH);
			var_dump($data);
			var_dump($_REQUEST);
			if(isset($_REQUEST['openid_oauth_request_token']))
			{
				$accessToken	= $this->getAccessToken($_REQUEST['openid_oauth_request_token']);
				var_dump($this->oauthRequest($accessToken, 'http://api.myspace.com/v1/users/570213225/profile'));
				
			}
			else
				trigger_error('DNS not register on Google', E_USER_NOTICE);
			exit;
			$this->redirectAfterConnection();
		}
	}
	private /*string*/ function oauthRequest(/*OAuthToken*/ $accessToken, /*string*/ $url)
	{
		$req = OAuthRequest::from_consumer_and_token($this->oAuthConsumer, $accessToken, 'GET', $url, NULL);
		$req->sign_request(new OAuthSignatureMethod_HMAC_SHA1(), $this->oAuthConsumer, $accessToken);
		return $this->send_signed_request($req->get_normalized_http_method(), $url, $req->to_header(), NULL, false);
	}
	private /*OAuthToken*/ function getAccessToken($request_token)
	{
		$token			= new OAuthToken($request_token, NULL);
		$token_endpoint	= 'http://api.myspace.com/access_token';
		$request		= OAuthRequest::from_consumer_and_token($this->oAuthConsumer, $token, 'GET', $token_endpoint);
		$request->sign_request(new OAuthSignatureMethod_HMAC_SHA1(), $this->oAuthConsumer, $token);
		
		$response = $this->send_signed_request($request->get_normalized_http_method(), $token_endpoint, $request->to_header(), NULL, false);
		
		// Parse out oauth_token (access token) and oauth_token_secret
		preg_match('/oauth_token=(.*)&oauth_token_secret=(.*)/', $response, $matches);
		return new OAuthToken(urldecode($matches[1]), urldecode($matches[2]));
	}
	/**
	 * Makes an HTTP request to the specified URL
	 *
	 * @param string $http_method The HTTP method (GET, POST, PUT, DELETE)
	 * @param string $url Full URL of the resource to access
	 * @param string $auth_header (optional) Authorization header
	 * @param string $postData (optional) POST/PUT request body
	 * @param bool $returnResponseHeaders True if resp. headers should be returned.
	 * @return string Response body from the server
	 */
	private /*string*/ function send_signed_request(/*string*/ $http_method, /*string*/ $url, /*string*/ $auth_header=null,	/*string*/ $postData=null, /*bool*/ $returnResponseHeaders=true)
	{
		$curl = curl_init($url);
		curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($curl, CURLOPT_FAILONERROR, false);
		curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);

		if ($returnResponseHeaders)
			curl_setopt($curl, CURLOPT_HEADER, true);
		switch($http_method)
		{
			case 'GET':
				if ($auth_header)
					curl_setopt($curl, CURLOPT_HTTPHEADER, array($auth_header));
				break;
			case 'POST':
				$headers = array('Content-Type: application/atom+xml', $auth_header);
				curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
				curl_setopt($curl, CURLOPT_POST, 1);
				curl_setopt($curl, CURLOPT_POSTFIELDS, $postData);
				break;
			case 'PUT':
				$headers = array('Content-Type: application/atom+xml', $auth_header);
				curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
				curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $http_method);
				curl_setopt($curl, CURLOPT_POSTFIELDS, $postData);
				break;
			case 'DELETE':
				$headers = array($auth_header);
				curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
				curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $http_method);
				break;
		}
		$response = curl_exec($curl);
		if (!$response)
			$response = curl_error($curl);
		curl_close($curl);
		return $response;
	}
	/**
	 * Function called to OpenId extensions
	 * @param $auth variable initialized by $this->consumer->begin()
	 */
	protected /*void*/ function initExtensions(/*Auth_OpenID_AuthRequest*/ $auth)
	{
		$auth->addExtensionArg('http://openid.net/srv/ax/1.0', 'mode', 'fetch_request');
		$auth->addExtensionArg('http://openid.net/srv/ax/1.0', 'required', 'fullname,firstname,lastname,gender,dob,image');
		// OAuth
		$auth->addExtensionArg('http://specs.openid.net/extensions/oauth/1.0', 'consumer', 'ca09cf41d3c047ecbed4eeac8b6f14c7');
		//$auth->addExtensionArg('http://specs.openid.net/extensions/oauth/1.0', 'scope', '');
	}
	/**
	 * Récupère l'URL à appeler par OpenId pour la connexion
	 */
	public /*string*/ function getProviderUrl()
	{
		return 'http://myspace.com';
	}
}
?>
